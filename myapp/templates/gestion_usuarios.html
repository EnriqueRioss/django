{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<head>
    <title>GESTIÓN USUARIOS | IIG - LUZ</title>
    <link rel="stylesheet" href="{% static '/styles/adminuser.css' %}">
</head>

<div class="main-content">
    <main class="barra-content">
      <header class="content-header">
        <div class="breadcrumb">
          <a href="{% url 'index' %}" class="breadcrumb-item">Inicio</a>
          <span class="breadcrumb-separator">></span>
          <span class="breadcrumb-item active">Gestión de Usuarios</span>
        </div>
      </header>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="margin: 1rem 0; padding: 1rem; border-radius: 0.5rem; background-color: {% if message.tags == 'success' %}var(--primary-lightblue){% elif message.tags == 'error' %}#f8d7da{% else %}var(--lighter-blue){% endif %}; color: {% if message.tags == 'success' %}var(--primary-darkerblue){% elif message.tags == 'error' %}#721c24{% else %}var(--primary-darkerblue){% endif %};">
              {{ message }}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="float: right; background: none; border: none; font-size: 1.5rem; cursor:pointer;">
                  <span aria-hidden="true">×</span>
              </button>
          </div>
        {% endfor %}
      {% endif %}

    <div class="users-content">
        <div class="contenido-header">
            <div class="header-content">
                <h1>Gestión de Usuarios</h1>
                <p>Administración de usuarios, roles y permisos del sistema</p>
            </div>
            <div class="header-actions">
                <button class="btn-primary" id="new-user-btn">
                <i class="fas fa-user-plus"></i>
                Nuevo Usuario
            </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <h3>Total Usuarios</h3>
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h2>{{ total_users }}</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <h3>Usuarios Activos</h3>
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-content">
                    <h2>{{ active_users }}</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <h3>Administradores</h3>
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="stat-content">
                    <h2>{{ admin_users_count }}</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <h3>Genetistas</h3>
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="stat-content">
                    <h2>{{ genetista_users_count }}</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <h3>Lectores</h3>
                    <i class="fas fa-book-reader"></i>
                </div>
                <div class="stat-content">
                    <h2>{{ lector_users_count }}</h2>
                </div>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tab-nav">
                <button class="tab-button active" data-tab="users-tab">Usuarios</button>
                <button class="tab-button" data-tab="roles">Roles y Permisos</button>
            </div>
        </div>

        <div class="tabs-content active" id="users-tab">
            <div class="content-card">
                <div class="card-header">
                    <h2>Lista de Usuarios</h2>
                    <p>Gestiona todos los usuarios del sistema</p>
                    <form method="GET" action="{% url 'gestion_usuarios' %}">
                        <div class="table-filters">
                            <div class="search-input">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Buscar por nombre, apellido o email..." name="buscar-usuario" id="buscar-usuario-input" value="{{ search_query }}">
                            </div>
                            <select name="role_filter" id="role-filter-select">
                                <option value="">Filtrar por rol</option>
                                {% for role_val, role_disp in genetista_roles_for_filter %}
                                <option value="{{ role_val }}" {% if current_role_filter == role_val %}selected{% endif %}>{{ role_disp }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn-buscar"><i class="fas fa-search"></i>Buscar</button>
                        </div>
                    </form>
                </div>
                <div class="card-content">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Apellido</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_obj in users_list %}
                                <tr>
                                    <td>{{ user_obj.get_full_name|default:user_obj.username }}</td>
                                    <td>N/A</td>
                                    <td>N/A</td>
                                    <td>{{ user_obj.email }}</td>
                                    <td>
                                        {% if user_obj.genetistas %}
                                            <span class="badge default">{{ user_obj.genetistas.get_rol_display }}</span>
                                        {% else %}
                                            <span class="badge outline">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user_obj.is_active %}
                                            <span class="badge success">Activo</span>
                                        {% else %}
                                            <span class="badge destructive">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn-icon">
                                                <i class="fas fa-ellipsis-h"></i>
                                            </button>
                                            <div class="dropdown-content">
                                                <button class="edit-user" id="edit-user"><i class="fas fa-edit"></i> Editar</button>
                                                <button class="modificar-pass" id="modificar-pass"><i class="fas fa-key"></i> Reestablecer Contraseña</button>
                                                
                                                <form method="POST" action="{% url 'toggle_user_active' user_obj.id %}" class="dropdown-form-action">
                                                    {% csrf_token %}
                                                    <button type="submit">
                                                        <i class="fas fa-toggle-{% if user_obj.is_active %}on{% else %}off{% endif %}"></i> 
                                                        {% if user_obj.is_active %}Desactivar{% else %}Activar{% endif %}
                                                    </button>
                                                </form>

                                                {% if user_obj.id != request.user.id %}
                                                <form method="POST" action="{% url 'delete_user_admin' user_obj.id %}" class="dropdown-form-action" onsubmit="return confirm('¿Está seguro de que desea eliminar este usuario ({{ user_obj.username }})? Esta acción no se puede deshacer.');">
                                                    {% csrf_token %}
                                                    <button type="submit" class="danger">
                                                        <i class="fas fa-trash"></i> Eliminar
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" style="text-align: center;">No se encontraron usuarios.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs-content" id="roles">
            <div class="content-card">
                <div class="card-header">
                    <h2>Gestión de Roles y Permisos</h2>
                    <p>Configura los roles y permisos del sistema</p>
                </div>
                <div class="card-content">
                    <p>La gestión detallada de permisos por rol se configura a nivel de código o a través del panel de administración de Django.</p>
                    <div class="roles-grid">
                        <div class="role-card">
                            <div class="role-header"><h3>Administrador</h3><p>Acceso completo al sistema</p></div>
                        </div>
                        <div class="role-card">
                            <div class="role-header"><h3>Genetista</h3><p>Acceso para gestionar historias clínicas y pacientes.</p></div>
                        </div>
                        <div class="role-card">
                            <div class="role-header"><h3>Lector</h3><p>Acceso de solo lectura a pacientes de genetistas asociados.</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>
</div>

<!-- Modal para Crear Nuevo Usuario -->
<div class="modal" id="newUserModal">
    <div class="modal-content" style="max-width: 55rem;">
      <div class="modal-header">
        <h2>Crear Nuevo Usuario</h2>
        <button type="button" class="modal-close" id="closeNewUserModalBtn">×</button>
      </div>
      <form method="POST" action="{% url 'gestion_usuarios' %}" id="newUserForm">
        {% csrf_token %}
        <div class="modal-body">
            <p>Completa la información para crear un nuevo usuario en el sistema.</p>
            
            <div class="form-group">
                {{ user_creation_form.first_name.label_tag }}
                {{ user_creation_form.first_name }}
                {% if user_creation_form.first_name.errors %}<ul class="errorlist">{% for error in user_creation_form.first_name.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
            </div>
            <div class="form-group">
                {{ user_creation_form.last_name.label_tag }}
                {{ user_creation_form.last_name }}
                {% if user_creation_form.last_name.errors %}<ul class="errorlist">{% for error in user_creation_form.last_name.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
            </div>
            <div class="form-group">
                {{ user_creation_form.email.label_tag }}
                {{ user_creation_form.email }}
                {% if user_creation_form.email.errors %}<ul class="errorlist">{% for error in user_creation_form.email.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
            </div>
            <div class="form-group">
                {{ user_creation_form.password.label_tag }}
                {{ user_creation_form.password }}
                {% if user_creation_form.password.errors %}<ul class="errorlist">{% for error in user_creation_form.password.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
            </div>
            <div class="form-group">
                {{ user_creation_form.password_confirm.label_tag }}
                {{ user_creation_form.password_confirm }}
                {% if user_creation_form.password_confirm.errors %}<ul class="errorlist">{% for error in user_creation_form.password_confirm.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
            </div>
            <div class="form-group">
                {{ user_creation_form.rol.label_tag }}
                {{ user_creation_form.rol }}
                {% if user_creation_form.rol.errors %}<ul class="errorlist">{% for error in user_creation_form.rol.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
            </div>
            <div class="form-group" id="associatedGenetistaGroup" style="display:none;"> <!-- Initially hidden -->
                {{ user_creation_form.associated_genetista.label_tag }}
                {{ user_creation_form.associated_genetista }}
                {% if user_creation_form.associated_genetista.help_text %}<p class="help-text">{{ user_creation_form.associated_genetista.help_text }}</p>{% endif %}
                {% if user_creation_form.associated_genetista.errors %}<ul class="errorlist">{% for error in user_creation_form.associated_genetista.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" id="cancelNewUserModalBtn">Cancelar</button>
            <button type="submit" name="create_user_submit" class="btn-primary">Crear Usuario</button>
        </div>
      </form>
    </div>
</div>





<!-- Modal para editar la información del usuario -->
<div class="modal" id="editUserModal">
    <div class="modal-content" style="max-width: 55rem;">
        <div class="modal-header">
            <h2><i class="fas fa-user"></i>Editar Usuario</h2>
            <button type="button" class="modal-close" id="closeEditUserModalBtn">×</button>
        </div>
        <form method="POST" action="" id="editUserForm">
            <div class="modal-body">
                <p>Modifica la información del usuario (nombre del usuario).</p>
                
                <div class="form-group">
                    <label for="user-name">Usuario</label>
                    <input type="text" name="username" id="username">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" name="email" id="email">
                </div>
                <div class="form-group">
                    <label for="user-role">Rol</label>
                    <select id="user-role" class="form-input" required>
                        <option value="">Seleccionar rol</option>
                        <option value="admin">Administrador</option>
                        <option value="genetista">Genetista</option>
                        <option value="lectura">Solo Lectura</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="user-role">Estado</label>
                    <select id="user-state" class="form-input" required>
                    <option value="">Seleccionar estado</option>
                    <option value="admin">Activo</option>
                    <option value="genetista">Inactivo</option>
                    <option value="lectura">Suspendido</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelEditUserModalBtn">Cancelar</button>
                <button type="submit" name="edit_user_submit" class="btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>




<!-- Modal para modificar la contraseña del usuario -->
<div class="modal" id="modificarPassModal">
    <div class="modal-content" style="max-width: 50rem;">
        <div class="modal-header">
            <h2><i class="fas fa-key"></i>Reestablecer Contraseña</h2>
            <button type="button" class="modal-close" id="closeModificarPassModalBtn">×</button>
        </div>
        <form method="POST" action="" id="modificarPassForm">
            <div class="modal-body">
                <p>Reestablece la contraseña del usuario para (nombre del usuario).</p>
                
                <div class="form-group">
                    <label for="new-pass">Nueva Contraseña</label>
                    <input type="password" name="new-password" id="new-password">
                    <p>Minimo 8 caracteres, debe incluir mayúsculas, minúsculas y números</p>
                </div>
                <div class="form-group">
                    <label for="confirm-pass">Confirmar Contraseña</label>
                    <input type="password" name="confirm-pass" id="confirm-pass">
                </div>
                <div class="aviso-card">
                    <div class="aviso-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Importante</h3>
                    </div>
                    <div class="aviso-content">
                        <p>Esta acción reestablecerá inmediatamente la contraseña del usuario y cerrará 
                            sus sesiones activas.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelModificarPassModalBtn">Cancelar</button>
                <button type="submit" name="modificar_pass_submit" class="btn-primary">Reestablecer Contraseña</button>
            </div>
        </form>
    </div>
</div>





<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching logic
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tabs-content').forEach(content => {
                content.classList.remove('active');
            });
            const tabId = this.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Modal Nuevo Usuario control
    const newUserModal = document.getElementById('newUserModal');
    const newUserBtn = document.getElementById('new-user-btn');
    const closeNewUserModalBtn = document.getElementById('closeNewUserModalBtn');
    const cancelNewUserModalBtn = document.getElementById('cancelNewUserModalBtn');

    if (newUserBtn) {
        newUserBtn.addEventListener('click', function() {
            if (newUserModal) newUserModal.classList.add('active');
        });
    }
    if (closeNewUserModalBtn) {
        closeNewUserModalBtn.addEventListener('click', function() {
            if (newUserModal) {
                newUserModal.classList.remove('active');
                // Optional: Reset form if desired when closing with 'x' or 'cancel'
                // document.getElementById('newUserForm').reset();
                // associatedGenetistaGroup.style.display = 'none'; // Ensure it's hidden on reset
            }
        });
    }
    if (cancelNewUserModalBtn) {
        cancelNewUserModalBtn.addEventListener('click', function() {
            if (newUserModal) {
                newUserModal.classList.remove('active');
                 // Optional: Reset form
                // document.getElementById('newUserForm').reset();
                // associatedGenetistaGroup.style.display = 'none';
            }
        });
    }
    if (newUserModal) {
        newUserModal.addEventListener('click', function(event) {
            if (event.target === newUserModal) {
                newUserModal.classList.remove('active');
                 // Optional: Reset form
                // document.getElementById('newUserForm').reset();
                // associatedGenetistaGroup.style.display = 'none';
            }
        });
    }
    
    // Conditional display for Associated Genetista field
    // Ensure you target the select within the #newUserForm
    const rolSelect = document.querySelector('#newUserForm select[name="rol"]'); 
    const associatedGenetistaGroup = document.getElementById('associatedGenetistaGroup');

    function toggleAssociatedGenetistaField() {
        if (rolSelect && associatedGenetistaGroup) {
            if (rolSelect.value === 'LEC') { // 'LEC' is the value for Lector role
                associatedGenetistaGroup.style.display = 'block';
            } else {
                associatedGenetistaGroup.style.display = 'none';
            }
        }
    }

    if (rolSelect) {
        rolSelect.addEventListener('change', toggleAssociatedGenetistaField);
        // Initial check in case the form is re-rendered with a value (e.g., after validation error)
        toggleAssociatedGenetistaField(); 
    }

    // Re-open modal if there are form errors on page load
    // The form_errors_exist variable should be set by Django template rendering
    const formErrorsExist = {{ form_errors_exist|yesno:"true,false" }};
    if (formErrorsExist && newUserModal) {
        newUserModal.classList.add('active');
        // Ensure the conditional field visibility is also re-evaluated
        toggleAssociatedGenetistaField(); 
    }

    // Dismiss alerts
    document.querySelectorAll('.alert .close').forEach(function(button) {
        button.addEventListener('click', function() {
            this.parentElement.style.display = 'none';
        });
    });

}); 



// Para el comportamiento del dropdown, que se despliegue al hacer click al boton de acciones y no solo hacer hover
document.addEventListener('DOMContentLoaded', function() {
    // Seleccionar todos los dropdowns
    const dropdowns = document.querySelectorAll('.dropdown');
    
    // Añadir evento click a cada botón de dropdown
    dropdowns.forEach(dropdown => {
        const btn = dropdown.querySelector('.btn-icon');
        const content = dropdown.querySelector('.dropdown-content');
        
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            
            // Cerrar otros dropdowns abiertos
            document.querySelectorAll('.dropdown-content').forEach(item => {
                if (item !== content) {
                    item.style.display = 'none';
                }
            });
            
            // Alternar el dropdown actual
            if (content.style.display === 'block') {
                content.style.display = 'none';
            } else {
                content.style.display = 'block';
            }
        });
    });



    // Cerrar dropdowns al hacer clic fuera de ellos
    document.addEventListener('click', function() {
        document.querySelectorAll('.dropdown-content').forEach(content => {
            content.style.display = 'none';
        });
    });
});




/*Para las modales de edición de usuario y de contraseña*/
document.addEventListener('DOMContentLoaded', function() {
    // Modal de Editar Usuario
    const editUserModal = document.getElementById('editUserModal');
    const editUserBtn = document.getElementById('edit-user');
    const closeEditUserModalBtn = document.getElementById('closeEditUserModalBtn');
    const cancelEditUserModalBtn = document.getElementById('cancelEditUserModalBtn');

    // Modal de Modificar Contraseña
    const modifyPassModal = document.getElementById('modificarPassModal');
    const modifyPassBtn = document.getElementById('modificar-pass');
    const closeModifyPassModalBtn = document.getElementById('closeModificarPassModalBtn');
    const cancelModifyPassModalBtn = document.getElementById('cancelModificarPassModalBtn');

    // Función para cerrar todas las modales
    function closeAllModals() {
        if (editUserModal) editUserModal.classList.remove('active');
        if (modifyPassModal) modifyPassModal.classList.remove('active');
    }

    // Eventos para Editar Usuario
    if (editUserBtn) {
        editUserBtn.addEventListener('click', function(e) {
            e.preventDefault();
            closeAllModals();
            if (editUserModal) editUserModal.classList.add('active');
        });
    }

    // Eventos para Modificar Contraseña
    if (modifyPassBtn) {
        modifyPassBtn.addEventListener('click', function(e) {
            e.preventDefault();
            closeAllModals();
            if (modifyPassModal) modifyPassModal.classList.add('active');
        });
    }

    // Eventos de cierre para ambas modales
    [closeEditUserModalBtn, cancelEditUserModalBtn].forEach(btn => {
        if (btn) {
            btn.addEventListener('click', closeAllModals);
        }
    });

    [closeModifyPassModalBtn, cancelModifyPassModalBtn].forEach(btn => {
        if (btn) {
            btn.addEventListener('click', closeAllModals);
        }
    });

    // Cerrar al hacer clic fuera del contenido
    [editUserModal, modifyPassModal].forEach(modal => {
        if (modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeAllModals();
                }
            });
        }
    });
});

</script>
{% endblock %}