{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href= "{% static '/styles/stylesforms.css' %}">
    <link rel="stylesheet" href="{% static 'styles/messages.css' %}">
    <script src="https://kit.fontawesome.com/8058dee255.js" crossorigin="anonymous"></script>
</head>
<body>

    <header>
        <div class="container-navbar">
            <nav class="navbar container">
                <div class="container-logo">
                    <h1 class="logo">GenClinic</h1>
                </div>
                <div class="opciones">
                    <ul class="menu">
                        <li>
                            <a href="{%  url 'index' %}">Inicio</a>
                            <a href="{% url 'pacientes_list_redirect' %}">Pacientes</a>
                            <a href="{% url 'reports_dashboard' %}">Reportes</a>
                            {% if user.is_authenticated %}
                            <a href="/logout">Logout</a>
                            {% else %}
                            <a href="{%  url 'login' %}">Login</a>
                            {% endif %}
                            
                            <span class="conf-logo">
                                <i class="fa-solid fa-gear"></i>
                            </span>
                            <span class="conf-logo">
                                <a href="{% url 'logout' %}" style="color: inherit; text-decoration: none;">
                                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                                </a>
                            </span>
                        </li>
                    </ul>
                </div>
            </nav>
            <hr>
        </div>
    </header>


    <div class="main-content-area">
        {% if messages %}
            <div class="messages-container">
                <ul class="messages">
                    {% for message in messages %}
                        <li{% if message.tags %} class="message-item {{ message.tags }}"{% endif %}>
                            {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
                                <i class="fas fa-times-circle"></i> Error:
                            {% elif message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
                                <i class="fas fa-check-circle"></i> Éxito:
                            {% elif message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}
                                <i class="fas fa-exclamation-triangle"></i> Advertencia:
                            {% elif message.level == DEFAULT_MESSAGE_LEVELS.INFO and not 'POPUP:' in message.message %}
                                <i class="fas fa-info-circle"></i> Información:
                            {% endif %}
                            {% if not 'POPUP:' in message.message %}
                                {{ message }}
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <div class="content">
            {% block content %}
            {% endblock %}
        </div>
    </div>
    
    <!-- ================================================================= -->
    <!-- === REUSABLE AJAX FORM HANDLING SCRIPT ========================== -->
    <!-- ================================================================= -->
<script>
        function setupAjaxForm(formId) {
            const form = document.getElementById(formId);
            if (!form) {
                console.error(`Form with ID "${formId}" not found.`);
                return;
            }
        
            let clickedButton = null;
        
            // 1. Captura qué botón de envío fue clickeado
            form.querySelectorAll('button[type="submit"]').forEach(button => {
                button.addEventListener('click', function() {
                    clickedButton = this;
                });
            });
        
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // Detener el envío normal
        
                const formData = new FormData(form);
        
                // 2. Añade el nombre y valor del botón clickeado al FormData
                if (clickedButton) {
                    formData.append(clickedButton.name, clickedButton.value || '');
                }
        
                // Limpiar errores previos
                form.querySelectorAll('.field-errors').forEach(el => el.innerHTML = '');
                const nonFieldErrors = form.querySelector('.non-field-errors');
                if (nonFieldErrors) nonFieldErrors.innerHTML = '';
        
        
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        // El CSRF token ya está en el FormData, no es necesario en headers
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.redirect_url) {
                        // Redirección exitosa
                        window.location.href = data.redirect_url;
                    } else {
                        // Manejar errores de validación
                        if (data.errors) {
                            // Errores globales del formulario
                            if (data.errors.__all__) {
                                data.errors.__all__.forEach(error => {
                                    if(nonFieldErrors) nonFieldErrors.innerHTML += `<span>${error}</span>`;
                                });
                            }
                            // Errores específicos de cada campo
                            for (const fieldName in data.errors) {
                                if (fieldName !== '__all__') {
                                    const errorDiv = document.getElementById(`error_id_${fieldName}`);
                                    const fieldErrorContainer = form.querySelector(`#error_id_${fieldName}`);
        
                                    if (fieldErrorContainer) {
                                        let errorHtml = '';
                                        data.errors[fieldName].forEach(error => {
                                            errorHtml += `<span>${error.message || error}</span>`;
                                        });
                                        fieldErrorContainer.innerHTML = errorHtml;
                                    }
                                }
                            }
                        } else {
                             if(nonFieldErrors) nonFieldErrors.innerHTML = '<span>Ocurrió un error inesperado.</span>';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error en la petición AJAX:', error);
                    if(nonFieldErrors) nonFieldErrors.innerHTML = '<span>Error de conexión. Intente de nuevo.</span>';
                });
        
                // Resetear el botón clickeado para el próximo envío
                clickedButton = null;
            });
        }
      

    document.addEventListener('DOMContentLoaded', function() {
        {% if messages %}
            {% for message in messages %}
                {% if 'POPUP:' in message.message %}
                    alert("{{ message.message|slice:'7:'|escapejs }}");
                {% endif %}
            {% endfor %}
        {% endif %}
    });
</script>
</body>
</html>